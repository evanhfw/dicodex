services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: builder
    container_name: student-dashboard-frontend-dev
    command: npm run dev -- --host
    ports:
      - "8080:8080"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      # Don't mount node_modules
      - /app/node_modules
    environment:
      - VITE_API_KEY=${VITE_API_KEY}
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: student-dashboard-backend-dev
    command: uv run uvicorn app.main:app --host 0.0.0.0 --port 3000 --reload
    # No port exposed â€” accessed via Vite proxy on internal network
    volumes:
      - ./backend/app:/app/app
      - ./backend/pyproject.toml:/app/pyproject.toml
      - scraped_data:/app/output
      # Don't mount .venv
      - /app/.venv
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - API_KEY=${API_KEY}
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    depends_on:
      - selenium
      - redis

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: student-dashboard-worker-dev
    command: uv run python -m app.run_worker
    volumes:
      - ./backend/app:/app/app
      - ./backend/pyproject.toml:/app/pyproject.toml
      - scraped_data:/app/output
      - /app/.venv
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    depends_on:
      - selenium
      - redis

  redis:
    image: redis:alpine
    container_name: student-dashboard-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  selenium:
    image: selenium/standalone-chrome:latest
    container_name: student-dashboard-selenium-dev
    ports:
      - "4444:4444"
      - "7900:7900"  # VNC server for debugging (http://localhost:7900, password: secret)
    shm_size: 512m
    environment:
      - SE_NODE_MAX_SESSIONS=2
      - SE_NODE_SESSION_TIMEOUT=120

  # ===================================
  # Monitoring Stack (dev overrides)
  # ===================================

  prometheus:
    image: prom/prometheus:latest
    container_name: student-dashboard-prometheus-dev
    ports:
      - "9090:9090"  # Accessible at http://localhost:9090
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
    depends_on:
      - backend

  grafana:
    image: grafana/grafana:latest
    container_name: student-dashboard-grafana-dev
    ports:
      - "3001:3000"  # Accessible at http://localhost:3001
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=http://localhost:3001/
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: student-dashboard-cadvisor-dev
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    privileged: true
    devices:
      - /dev/kmsg

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: student-dashboard-redis-exporter-dev
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      - redis

  alertmanager:
    image: prom/alertmanager:latest
    container_name: student-dashboard-alertmanager-dev
    ports:
      - "9093:9093"  # Accessible at http://localhost:9093
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.tmpl:ro
      - ./monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
    entrypoint:
      - /bin/sh
      - -c
      - |
        sed "s|DISCORD_WEBHOOK_URL_PLACEHOLDER|$$DISCORD_ALERT_WEBHOOK_URL|g" \
          /etc/alertmanager/alertmanager.tmpl > /etc/alertmanager/alertmanager.yml && \
        /bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml
    environment:
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}

volumes:
  scraped_data:
    name: student_dashboard_data_dev
  redis_data:
    name: student_dashboard_redis_dev
  prometheus_data:
    name: student_dashboard_prometheus_dev
  grafana_data:
    name: student_dashboard_grafana_dev
