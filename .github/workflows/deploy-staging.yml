name: Deploy Staging to VPS

# ============================================
# Required GitHub Secrets:
# ============================================
# DOCKER_USERNAME              - Docker Hub username
# DOCKER_PASSWORD              - Docker Hub password/token
# HOST                         - VPS IP address or hostname
# USERNAME                     - VPS SSH username
# VPS_PASSWORD                 - VPS SSH password
#
# STAGING_HOST_PORT            - Frontend port for staging (default: 8081)
# STAGING_DEPLOY_PATH          - Path on VPS for staging deployment
# STAGING_API_KEY              - API key for staging backend
# STAGING_CONN_PSQL            - PostgreSQL connection string (staging)
# STAGING_POSTGRES_TABLE_NAME  - PostgreSQL table name (staging)
#
# Optional:
# STAGING_DISCORD_STATS_WEBHOOK_URL    - Webhook for daily stats
# STAGING_DISCORD_MONITOR_WEBHOOK_URL  - Webhook for health reports
# STAGING_DISCORD_ALERT_WEBHOOK_URL    - Webhook for critical alerts
# STAGING_MONITOR_INTERVAL             - Monitoring interval in seconds
#
# Prerequisite: Production must be deployed first (creates shared network)
# ============================================

on:
  push:
    branches: [ "staging" ]
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v6.0.2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push frontend
        uses: docker/build-push-action@v6.18.0
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/cohort-dashboard-frontend:staging
          build-args: |
            VITE_API_KEY=${{ secrets.STAGING_API_KEY }}

      - name: Build and push backend
        uses: docker/build-push-action@v6.18.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/cohort-dashboard-backend:staging

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            if ! docker network inspect dashboard-shared-network > /dev/null 2>&1; then
              echo "ERROR: dashboard-shared-network not found!"
              echo "Production must be deployed first to create the shared network."
              exit 1
            fi
            
            mkdir -p ${{ secrets.STAGING_DEPLOY_PATH }}
            cd ${{ secrets.STAGING_DEPLOY_PATH }}
            
            cat > .env << 'EOF'
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            STAGING_HOST_PORT=${{ secrets.STAGING_HOST_PORT }}
            STAGING_API_KEY=${{ secrets.STAGING_API_KEY }}
            STAGING_CONN_PSQL=${{ secrets.STAGING_CONN_PSQL }}
            STAGING_POSTGRES_TABLE_NAME=${{ secrets.STAGING_POSTGRES_TABLE_NAME }}
            STAGING_DISCORD_STATS_WEBHOOK_URL=${{ secrets.STAGING_DISCORD_STATS_WEBHOOK_URL }}
            STAGING_DISCORD_MONITOR_WEBHOOK_URL=${{ secrets.STAGING_DISCORD_MONITOR_WEBHOOK_URL }}
            STAGING_DISCORD_ALERT_WEBHOOK_URL=${{ secrets.STAGING_DISCORD_ALERT_WEBHOOK_URL }}
            STAGING_MONITOR_INTERVAL=${{ secrets.STAGING_MONITOR_INTERVAL }}
            EOF
            sed -i 's/^[[:space:]]*//' .env

            # Fail fast if required staging secrets are missing/empty
            required_vars="DOCKER_USERNAME STAGING_API_KEY STAGING_CONN_PSQL STAGING_POSTGRES_TABLE_NAME"
            for var in $required_vars; do
              value="$(grep -E "^${var}=" .env | head -n1 | cut -d= -f2-)"
              if [ -z "$value" ]; then
                echo "ERROR: Required staging variable '$var' is empty or not set."
                exit 1
              fi
            done
            
            curl -o docker-compose.staging.yml https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/docker-compose.staging.yml

            # Rendered compose should show concrete values for critical env vars
            docker compose -f docker-compose.staging.yml config > /tmp/staging-compose-rendered.yml
            if grep -qE 'CONN_PSQL: ""|API_KEY: ""' /tmp/staging-compose-rendered.yml; then
              echo "ERROR: Resolved compose contains empty CONN_PSQL/API_KEY."
              exit 1
            fi
            
            docker compose -f docker-compose.staging.yml pull
            docker compose -f docker-compose.staging.yml down
            docker compose -f docker-compose.staging.yml up -d
            docker image prune -f
            docker ps | grep staging

      - name: Notify Discord on Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content":"✅ Staging deployed successfully!"}' \
               ${{ secrets.STAGING_DISCORD_ALERT_WEBHOOK_URL || secrets.DISCORD_ALERT_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Discord on Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{"content":"❌ Staging deployment failed!"}' \
               ${{ secrets.STAGING_DISCORD_ALERT_WEBHOOK_URL || secrets.DISCORD_ALERT_WEBHOOK_URL }}
        continue-on-error: true
