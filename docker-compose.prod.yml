services:
  frontend:
    image: ${DOCKER_USERNAME}/cohort-dashboard-frontend:latest
    container_name: student-dashboard-frontend
    ports:
      - "${HOST_PORT:-8080}:8080"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  backend:
    image: ${DOCKER_USERNAME}/cohort-dashboard-backend:latest
    container_name: student-dashboard-backend
    # No port exposed — accessed via Nginx reverse proxy on internal network
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - API_KEY=${API_KEY}
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL}
      - POSTGRES_TABLE_NAME=${POSTGRES_TABLE_NAME}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    volumes:
      - scraped_data:/app/output
    depends_on:
      - selenium
      - redis
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  worker:
    image: ${DOCKER_USERNAME}/cohort-dashboard-backend:latest
    container_name: student-dashboard-worker
    command: uv run python -m app.run_worker
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL}
      - POSTGRES_TABLE_NAME=${POSTGRES_TABLE_NAME}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    volumes:
      - scraped_data:/app/output
    depends_on:
      - selenium
      - redis
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  redis:
    image: redis:alpine
    container_name: student-dashboard-redis
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  selenium:
    image: selenium/standalone-chrome:latest
    container_name: student-dashboard-selenium
    # No ports exposed — only backend/worker access via Docker internal network
    shm_size: 512m
    environment:
      - SE_NODE_MAX_SESSIONS=3
      - SE_NODE_SESSION_TIMEOUT=120
      - SE_SESSION_REQUEST_TIMEOUT=60
      - SE_SESSION_RETRY_INTERVAL=2
      - JAVA_OPTS=-Xmx256m
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    restart: unless-stopped
    networks:
      - dashboard-shared

  # ===================================
  # Monitoring Stack
  # ===================================

  prometheus:
    image: prom/prometheus:latest
    container_name: student-dashboard-prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  grafana:
    image: grafana/grafana:latest
    container_name: student-dashboard-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL:-/grafana/}
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: student-dashboard-cadvisor
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    privileged: true
    devices:
      - /dev/kmsg
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: student-dashboard-redis-exporter
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  alertmanager:
    image: prom/alertmanager:latest
    container_name: student-dashboard-alertmanager
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.tmpl:ro
      - ./monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
    entrypoint:
      - /bin/sh
      - -c
      - |
        sed "s|DISCORD_WEBHOOK_URL_PLACEHOLDER|$$DISCORD_ALERT_WEBHOOK_URL|g" \
          /etc/alertmanager/alertmanager.tmpl > /etc/alertmanager/alertmanager.yml && \
        /bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml
    environment:
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

volumes:
  scraped_data:
    name: student_dashboard_data_prod
  redis_data:
    name: student_dashboard_redis_prod
  prometheus_data:
    name: student_dashboard_prometheus_prod
  grafana_data:
    name: student_dashboard_grafana_prod

networks:
  dashboard-network:
    name: dashboard-prod-network
    driver: bridge
  dashboard-shared:
    name: dashboard-shared-network
    driver: bridge
