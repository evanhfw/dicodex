services:
  frontend:
    image: ${DOCKER_USERNAME:?DOCKER_USERNAME is required}/cohort-dashboard-frontend:latest
    container_name: student-dashboard-frontend
    ports:
      - "${HOST_PORT:-8080}:8080"
    environment:
      - BACKEND_HOST=backend
      - API_KEY=${API_KEY:?API_KEY is required}
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  backend:
    image: ${DOCKER_USERNAME:?DOCKER_USERNAME is required}/cohort-dashboard-backend:latest
    container_name: student-dashboard-backend
    # No port exposed — accessed via Nginx reverse proxy on internal network
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - API_KEY=${API_KEY:?API_KEY is required}
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL:?CONN_PSQL is required}
      - POSTGRES_TABLE_NAME=${POSTGRES_TABLE_NAME:?POSTGRES_TABLE_NAME is required}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    volumes:
      - scraped_data:/app/output
    depends_on:
      - selenium
      - redis
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  worker:
    image: ${DOCKER_USERNAME:?DOCKER_USERNAME is required}/cohort-dashboard-backend:latest
    container_name: student-dashboard-worker
    command: uv run python -m app.run_worker
    environment:
      - SELENIUM_URL=http://selenium:4444
      - CODINGCAMP_URL=https://codingcamp.dicoding.com
      - REDIS_URL=redis://redis:6379
      - CONN_PSQL=${CONN_PSQL:?CONN_PSQL is required}
      - POSTGRES_TABLE_NAME=${POSTGRES_TABLE_NAME:?POSTGRES_TABLE_NAME is required}
      - DISCORD_STATS_WEBHOOK_URL=${DISCORD_STATS_WEBHOOK_URL}
      - DISCORD_MONITOR_WEBHOOK_URL=${DISCORD_MONITOR_WEBHOOK_URL}
      - DISCORD_ALERT_WEBHOOK_URL=${DISCORD_ALERT_WEBHOOK_URL}
      - MONITOR_INTERVAL=${MONITOR_INTERVAL}
    volumes:
      - scraped_data:/app/output
    depends_on:
      - selenium
      - redis
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  redis:
    image: redis:alpine
    container_name: student-dashboard-redis
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - dashboard-network
      - dashboard-shared

  selenium:
    image: selenium/standalone-chrome:latest
    container_name: student-dashboard-selenium
    # No ports exposed — only backend/worker access via Docker internal network
    shm_size: 512m
    environment:
      - SE_NODE_MAX_SESSIONS=3
      - SE_NODE_SESSION_TIMEOUT=120
      - SE_SESSION_REQUEST_TIMEOUT=60
      - SE_SESSION_RETRY_INTERVAL=2
      - JAVA_OPTS=-Xmx256m
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    restart: unless-stopped
    networks:
      - dashboard-shared

volumes:
  scraped_data:
    name: student_dashboard_data_prod
  redis_data:
    name: student_dashboard_redis_prod

networks:
  dashboard-network:
    name: dashboard-prod-network
    driver: bridge
  dashboard-shared:
    name: dashboard-shared-network
    driver: bridge
